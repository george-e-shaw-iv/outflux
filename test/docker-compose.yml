version: "3"

services:
  # InfluxDB for the test server, isolated in its own network along
  # with the outflux server daemon in order to sync with the client
  # InfluxDB instance.
  influx-server:
    image: influxdb:2.2.0-alpine
    platform: linux/x86_64 # Make it work on Apple silicon.
    environment:
      - DOCKER_INFLUXDB_INIT_USERNAME=outflux
      - DOCKER_INFLUXDB_INIT_PASSWORD=outflux
      - DOCKER_INFLUXDB_INIT_ORG=outflux-server
      - DOCKER_INFLUXDB_INIT_BUCKET=test
    networks:
      - server

  # outflux server which is communicated to via the outflux client
  # package using gRPC requests.
  outflux-server:
    image: alpine:latest
    networks:
      # The client and server need to be able to communicate so they
      # are the only two services that share both networks.
      - server
      - client
    depends_on:
      - influx-server

  # InfluxDB for the test client.
  influx-client:
    image: influxdb:2.2.0-alpine
    platform: linux/x86_64 # Make it work on Apple silicon.
    environment:
      - DOCKER_INFLUXDB_INIT_USERNAME=outflux
      - DOCKER_INFLUXDB_INIT_PASSWORD=outflux
      - DOCKER_INFLUXDB_INIT_ORG=outflux-client
      - DOCKER_INFLUXDB_INIT_BUCKET=test
      - DOCKER_INFLUXDB_INIT_ADMIN_TOKEN=test-admin-token
    networks:
      - client
    depends_on:
      - influx-server

  # Telegraf for the test client.
  telegraf-client:
    image: telegraf:1.22.4-alpine
    command: >
      sh -c "mkdir -p /telegraf &&
      sudo chown -R telegraf:telegraf /telegraf &&
      telegraf"
    platform: linux/x86_64 # Make it work on Apple silicon.
    environment:
      # These environment variables are used in the telegraf configuration
      # file. These should be what the influx-client use.
      - DOCKER_INFLUXDB_INIT_ORG=outflux-client
      - DOCKER_INFLUXDB_INIT_BUCKET=test
      - DOCKER_INFLUXDB_INIT_ADMIN_TOKEN=test-admin-token
    volumes:
      # Metrics written to influx-client are dual-written as InfluxDB
      # Line Data is written to /telegraf/metrics.out. This is configured
      # in the test/client/telegraf.conf file which is used by telegraf-client.
      - telegraf:/telegraf

      # Telegraf configuration file mount.
      - ./client/telegraf.conf:/etc/telegraf/telegraf.conf
    restart: on-failure
    networks:
      - client
    depends_on:
      - influx-client

  outflux-client:
    image: alpine:latest
    volumes:
      # This is the shared volume between telegraf-client and outflux-client
      # where metrics written to influx-client are dual-written to in the form
      # of InfluxDB Line Data into a file, which outflux-client reads from.
      - telegraf:/telegraf
    networks:
      # The client and server need to be able to communicate so they
      # are the only two services that share both networks.
      - client
      - server

volumes:
  # telegraf is a shared volume between telegraf-client and outflux-client.
  # telegraf-client writes to a file the volume and outflux-client reads
  # from it.
  telegraf:

networks:
  server:
  client: